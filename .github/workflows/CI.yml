name: CI
on: pull_request

jobs:
  test:
    runs-on: ubuntu-20.04

    steps:
      # Check out, and set up the node/ruby infra
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "14"

      # Get local dependencies & test
      - run: yarn install
      - run: yarn build
      - run: yarn test

      # Validate related tooling
      - run: yarn declarations
      - run: yarn tsc distribution/danger.d.ts
      - run: rm -rf node_modules/@types/babel-*
      - run: rm -rf node_modules/@types/babylon

      # Not many Flow users nowadays, so this probably is worth dropping
      # if it becomes an issue.
      - run: echo "Testing Flow definition file"
      - run: yarn build:flow-types

      - run: echo "Running built Danger"
      - run: node distribution/commands/danger-ci.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
